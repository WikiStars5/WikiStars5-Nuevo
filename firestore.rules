
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Global Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    function isIncrement(field, count) {
      // This is a simplified function for simple numeric fields, not for maps.
      let nextValue = request.resource.data[field];
      let prevValue = resource.data[field];
      return nextValue == prevValue + count;
    }

    // --- Figure Vote Helper Functions ---

    // Checks for a +1 increment on a single field within a vote map.
    // Used for a user's FIRST vote.
    function isVoteIncrement(voteType, voteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];
        
        // Check if only the specific vote field is being incremented by 1
        return nextVoteMap[voteField] == prevVoteMap[voteField] + 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([voteField]);
    }
    
    // Checks for a -1 decrement on a single field within a vote map.
    // Used when a user RETRACTS their vote.
    function isVoteDecrement(voteType, voteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];

        // Check if only the specific vote field is being decremented by 1
        return nextVoteMap[voteField] == prevVoteMap[voteField] - 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([voteField]);
    }

    // Checks for a -1 decrement on the old field and a +1 increment on the new field.
    // Used when a user CHANGES their vote from one option to another.
    function isChangingVote(voteType, oldVoteField, newVoteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];

        // Check if old vote is decremented and new vote is incremented, and nothing else changed.
        return nextVoteMap[oldVoteField] == prevVoteMap[oldVoteField] - 1 &&
               nextVoteMap[newVoteField] == prevVoteMap[newVoteField] + 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([oldVoteField, newVoteField]);
    }
    
    // --- User Data Collections ---

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();

      // Rules for user's private subcollections
      match /attitudeVotes/{figureId} {
        allow get, write: if isOwner(userId);
        allow list: if isOwner(userId);
      }
      match /emotionVotes/{figureId} {
        allow get, write: if isOwner(userId);
        allow list: if isOwner(userId);
      }
       match /streaks/{streakId} {
        allow get, list, write: if isOwner(userId);
      }
      match /user_achievements/{achievementId} {
        allow get, list, write: if isOwner(userId);
      }
      match /notifications/{notificationId} {
          allow read, update, delete: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isSignedIn();
      }
      match /referrals/{referredUserId} {
        allow read, write: if isOwner(userId);
      }
    }

    match /status/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if false;
    }

    match /usernames/{username} {
      allow get: if true; 
      allow list: if false;
      allow create: if isSignedIn(); 
      allow delete: if get(/databases/$(database)/documents/usernames/$(username)).data.userId == request.auth.uid;
      allow update: if false;
    }

    // --- Figure Data Collections ---

    match /figures/{figureId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow delete: if isAdmin();
      
      allow update: if isAdmin() || (
        isSignedIn() && (
          // Allow authorized users to edit biographical data
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'name', 'imageUrl', 'imageHint', 'nationality', 'tags', 'tagsLower', 'description', 
            'gender', 'birthDate', 'deathDate', 'occupation', 'maritalStatus', 'height', 'socialLinks', 'nameKeywords', 'updatedAt'
          ])) ||
          
          // Allow atomic vote changes for attitude.
          // The __oldVote and __newVote fields are temporary fields sent from the client
          // that are not actually saved to the document but are available in request.resource.data.
          (request.resource.data.__newVote != null && 
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attitude', 'updatedAt', '__oldVote', '__newVote']) &&
           (
             // Scenario 1: First vote (no previous vote)
             (request.resource.data.__oldVote == null && isVoteIncrement('attitude', request.resource.data.__newVote)) || 
             
             // Scenario 2: Retracting a vote (new and old are the same)
             (request.resource.data.__oldVote == request.resource.data.__newVote && isVoteDecrement('attitude', request.resource.data.__oldVote)) || 
             
             // Scenario 3: Changing a vote (new and old are different)
             (request.resource.data.__oldVote != request.resource.data.__newVote && isChangingVote('attitude', request.resource.data.__oldVote, request.resource.data.__newVote))
           )
          ) ||

          // Allow atomic vote changes for emotion.
          (request.resource.data.__newVote != null &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['emotion', 'updatedAt', '__oldVote', '__newVote']) &&
           (
             (request.resource.data.__oldVote == null && isVoteIncrement('emotion', request.resource.data.__newVote)) ||
             (request.resource.data.__oldVote == request.resource.data.__newVote && isVoteDecrement('emotion', request.resource.data.__oldVote)) ||
             (request.resource.data.__oldVote != request.resource.data.__newVote && isChangingVote('emotion', request.resource.data.__oldVote, request.resource.data.__newVote))
           )
          ) ||
          
          // Allow atomic increments for ratings
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ratingCount', 'totalRating', 'ratingsBreakdown']) && isIncrement('ratingCount', 1))
        )
      );
      
      // Rules for public-facing subcollections within figures
      match /attitudeVotes/{userId} {
          allow get, write: if isOwner(userId);
      }
      match /emotionVotes/{userId} {
          allow get, write: if isOwner(userId);
      }
      
      match /comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && (
          (resource.data.userId == request.auth.uid && request.resource.data.text != resource.data.text) ||
          isIncrement('likes', 1) || isIncrement('dislikes', 1) || isIncrement('likes', -1) || isIncrement('dislikes', -1)
        );
        allow delete: if resource.data.userId == request.auth.uid || isAdmin();
      
        match /votes/{userId} {
            allow get, write: if isOwner(userId);
            allow list: if false;
        }

        match /replies/{replyId} {
          allow get, list: if true;
          allow create: if isSignedIn();
          allow update: if isSignedIn() && (
            (resource.data.userId == request.auth.uid && request.resource.data.text != resource.data.text) ||
            isIncrement('likes', 1) || isIncrement('dislikes', 1) || isIncrement('likes', -1) || isIncrement('dislikes', -1)
          );
          allow delete: if 
            resource.data.userId == request.auth.uid ||
            get(/databases/$(database)/documents/figures/$(figureId)/comments/$(commentId)).data.userId == request.auth.uid ||
            isAdmin();
            
          match /votes/{userId} {
            allow get, write: if isOwner(userId);
            allow list: if false;
          }
        }
      }

      // --- /figures/{figureId}/streaks/{userId} ---
      // This is for the public leaderboard on the figure's page.
      match /streaks/{userId} {
        allow read, list: if true; 
        allow write: if isOwner(userId);
      }

       // --- /figures/{figureId}/achievements/{userAchievementId} ---
       // This is for the public achievement board on the figure's page.
      match /achievements/{userAchievementId} {
          allow read, list: if true;
          allow create: if isSignedIn(); // System/user can grant achievement
          allow delete, update: if false; // Achievements are permanent per figure
      }
    }
    
    // --- Other Root-Level Collections ---

    match /hashtags/{hashtagId} {
        allow get, list: if true;
        allow write: if isSignedIn();
    }
    
     match /achievements/{achievementId} {
        allow get, list: if true;
        allow write: if isAdmin(); // Only admins can define master achievements
    }


    match /related_figures/{relatedFigureId} {
      allow get, list: if true;
      allow create, delete: if isSignedIn();
      allow update: if false;
    }

    match /goat_battles/{battleId} {
        allow get, list: if true; 
        allow create, delete: if isAdmin(); // Solo el Admin puede crear/borrar
        
        allow update: if (
            // Permiso 1: El administrador puede actualizar cualquier campo
            isAdmin() ||
            
            // Permiso 2: Cualquier usuario autenticado puede incrementar los votos (isIncrement)
            (isSignedIn() && (
                (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['messiVotes']) && (isIncrement('messiVotes', 1) || isIncrement('messiVotes', -1))) ||
                (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ronaldoVotes']) && (isIncrement('ronaldoVotes', 1) || isIncrement('ronaldoVotes', -1)))
            ))
        );
        
        // El resto de la subcolecci√≥n de votos queda igual
        match /votes/{userId} {
            allow get, write: if isOwner(userId);
            allow list: if false;
        }
    }
    
    match /roles_admin/{userId} {
      allow get: if isSignedIn();
      allow write: if isAdmin();
      allow list: if false;
      
    }
    
    match /settings/{settingId} {
      allow get: if true;
      allow write: if isAdmin();
    }
  }
}

    