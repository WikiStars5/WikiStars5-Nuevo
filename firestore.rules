rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Global Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    function isIncrement(field, count) {
      let nextValue = request.resource.data[field];
      let prevValue = resource.data[field];
      return nextValue == prevValue + count || (prevValue == null && nextValue == count); 
    }

    // --- Figure Vote Helper Functions ---

    function isVoteIncrement(voteType, voteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];
        return nextVoteMap[voteField] == prevVoteMap[voteField] + 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([voteField]);
    }
    
    function isVoteDecrement(voteType, voteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];
        return nextVoteMap[voteField] == prevVoteMap[voteField] - 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([voteField]);
    }

    function isChangingVote(voteType, oldVoteField, newVoteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];
        return nextVoteMap[oldVoteField] == prevVoteMap[oldVoteField] - 1 &&
               nextVoteMap[newVoteField] == prevVoteMap[newVoteField] + 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([oldVoteField, newVoteField]);
    }
    
    // --- User Data Collections ---

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();

      match /attitudeVotes/{figureId} { allow get, write, list: if isOwner(userId); }
      match /emotionVotes/{figureId} { allow get, write, list: if isOwner(userId); }
      match /streaks/{streakId} { allow get, list, write: if isOwner(userId); }
      match /user_achievements/{achievementId} { allow get, list, write: if isOwner(userId); }
      match /notifications/{notificationId} { allow read, update, delete, list: if isOwner(userId); allow create: if isSignedIn(); }
      match /referrals/{referredUserId} { allow read, write: if isOwner(userId); }
    }

    match /usernames/{username} {
      allow get: if true; 
      allow list: if false;
      allow create: if isSignedIn(); 
      allow delete: if get(/databases/$(database)/documents/usernames/$(username)).data.userId == request.auth.uid;
      allow update: if false;
    }

    // --- Figure Data Collections ---

    match /figures/{figureId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow delete: if isAdmin();
      
      allow update: if isAdmin() || (
        isSignedIn() && (
          // P1: Wiki field edits
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'imageUrl', 'imageHint', 'nationality', 'tags', 'tagsLower', 'description', 'gender', 'birthDate', 'deathDate', 'occupation', 'maritalStatus', 'height', 'socialLinks', 'nameKeywords', 'updatedAt'])) ||
          
          // P2: Attitude voting
          (request.resource.data.__newVote != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attitude', 'updatedAt', '__oldVote', '__newVote']) && (
            (request.resource.data.__oldVote == null && isVoteIncrement('attitude', request.resource.data.__newVote)) ||
            (request.resource.data.__oldVote == request.resource.data.__newVote && isVoteDecrement('attitude', request.resource.data.__oldVote)) ||
            (request.resource.data.__oldVote != request.resource.data.__newVote && isChangingVote('attitude', request.resource.data.__oldVote, request.resource.data.__newVote))
          )) ||

          // P3: Emotion voting
          (request.resource.data.__newVote != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['emotion', 'updatedAt', '__oldVote', '__newVote']) && (
            (request.resource.data.__oldVote == null && isVoteIncrement('emotion', request.resource.data.__newVote)) ||
            (request.resource.data.__oldVote == request.resource.data.__newVote && isVoteDecrement('emotion', request.resource.data.__oldVote)) ||
            (request.resource.data.__oldVote != request.resource.data.__newVote && isChangingVote('emotion', request.resource.data.__oldVote, request.resource.data.__newVote))
          )) ||
          
          // P4: Rating update (the core of the fix)
          (
            (
                // Case A: Adding or removing a rating
                request.resource.data.__ratingCount_delta == 1 || request.resource.data.__ratingCount_delta == -1
            ) &&
            request.resource.data.ratingCount == resource.data.ratingCount + request.resource.data.__ratingCount_delta &&
            request.resource.data.totalRating == resource.data.totalRating + request.resource.data.__totalRating_delta &&
            (
                (
                    // Adding a rating
                    request.resource.data.__ratingCount_delta == 1 &&
                    request.resource.data.ratingsBreakdown[string(request.resource.data.__totalRating_delta)] == resource.data.ratingsBreakdown[string(request.resource.data.__totalRating_delta)] + 1
                ) ||
                (
                    // Removing a rating
                    request.resource.data.__ratingCount_delta == -1 &&
                    request.resource.data.ratingsBreakdown[string(request.resource.data.__totalRating_delta * -1)] == resource.data.ratingsBreakdown[string(request.resource.data.__totalRating_delta * -1)] - 1
                )
            )
          ) ||
          (
            (
                // Case B: Changing a rating
                request.resource.data.__ratingCount_delta == 0 && request.resource.data.ratingCount == resource.data.ratingCount
            ) &&
            request.resource.data.totalRating == resource.data.totalRating + request.resource.data.__totalRating_delta &&
            // This part is too complex to reliably verify in security rules without the __ratingUpdates map.
            // We trust the client to send the correct breakdown increments and only verify the total.
            // A more robust solution would involve a Cloud Function if this becomes a critical security concern.
            request.resource.data.ratingsBreakdown.diff(resource.data.ratingsBreakdown).affectedKeys().size() == 2
          )
        )
      );
      
      match /attitudeVotes/{userId} { allow get, write: if isOwner(userId); }
      match /emotionVotes/{userId} { allow get, write: if isOwner(userId); }
      
      match /comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid && 
                      request.resource.data.text is string && 
                      request.resource.data.text.size() > 0 &&
                      // Enforce one comment per user per figure
                      getAfter(/databases/$(database)/documents/figures/$(figureId)/comments?orderBy=userId&limit=1&query.equalTo=$(request.auth.uid)).size() == 0;

        allow update: if isSignedIn() && (
            (resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'updatedAt'])) || // Text edit
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']) && (isIncrement('likes', 1) || isIncrement('likes', -1))) || // Like/unlike
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dislikes']) && (isIncrement('dislikes', 1) || isIncrement('dislikes', -1))) || // Dislike/undislike
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes']) && ((isIncrement('likes', -1) && isIncrement('dislikes', 1)) || (isIncrement('dislikes', -1) && isIncrement('likes', 1)))) || // Change vote
            // This is the new rule to allow voiding an old rating
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'updatedAt']) && request.resource.data.rating == -1 && resource.data.userId == request.auth.uid)
        );
        
        allow delete: if resource.data.userId == request.auth.uid || isAdmin();

        match /votes/{userId} { allow get, write: if isOwner(userId); allow list: if false; }

        match /replies/{replyId} {
          allow get, list: if true;
          allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid && request.resource.data.text is string && request.resource.data.text.size() > 0;
          allow update: if isSignedIn() && (
              (resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'updatedAt'])) ||
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']) && (isIncrement('likes', 1) || isIncrement('likes', -1))) ||
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dislikes']) && (isIncrement('dislikes', 1) || isIncrement('dislikes', -1))) ||
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes']) && ((isIncrement('likes', -1) && isIncrement('dislikes', 1)) || (isIncrement('dislikes', -1) && isIncrement('likes', 1))))
          );
          allow delete: if resource.data.userId == request.auth.uid || get(/databases/$(database)/documents/figures/$(figureId)/comments/$(commentId)).data.userId == request.auth.uid || isAdmin();
          match /votes/{userId} { allow get, write: if isOwner(userId); allow list: if false; }
        }
      }

      match /streaks/{userId} { allow read, list: if true; allow write: if isOwner(userId); }
      match /achievements/{userAchievementId} { allow read, list: if true; allow create: if isSignedIn(); allow delete, update: if false; }
    }
    
    // --- Other Root-Level Collections ---

    match /hashtags/{hashtagId} { allow get, list: if true; allow write: if isSignedIn(); }
    match /achievements/{achievementId} { allow get, list: if true; allow write: if isAdmin(); }
    match /related_figures/{relatedFigureId} { allow get, list: if true; allow create, delete: if isSignedIn(); allow update: if false; }

    match /goat_battles/{battleId} {
        allow get, list: if true;
        allow create, delete: if isAdmin();
        allow update: if (
            isAdmin() || (
                isSignedIn() && (
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['messiVotes']) && (isIncrement('messiVotes', 1) || isIncrement('messiVotes', -1))) ||
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ronaldoVotes']) && (isIncrement('ronaldoVotes', 1) || isIncrement('ronaldoVotes', -1))) ||
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['messiVotes', 'ronaldoVotes']) && ((isIncrement('messiVotes', 1) && isIncrement('ronaldoVotes', -1)) || (isIncrement('messiVotes', -1) && isIncrement('ronaldoVotes', 1))))
                )
            )
        );
        match /votes/{userId} { allow get, write: if isOwner(userId); allow list: if false; }
    }
    
    match /roles_admin/{userId} { allow get: if isSignedIn(); allow write: if isAdmin(); allow list: if false; }
    match /settings/{settingId} { allow get: if true; allow write: if isAdmin(); }
  }
}
