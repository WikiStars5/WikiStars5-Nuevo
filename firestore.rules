rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Global Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    // âœ… Maneja la inicializaciÃ³n de campos (null a 'count').
    function isIncrement(field, count) {
      let nextValue = request.resource.data[field];
      let prevValue = resource.data[field];
      // Permite el incremento/decremento O la inicializaciÃ³n a 'count' si el valor anterior es nulo
      return nextValue == prevValue + count || (prevValue == null && nextValue == count); 
    }

    // --- Figure Vote Helper Functions (LÃ³gica avanzada: MUY SEGURA) ---

    function isVoteIncrement(voteType, voteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];
        
        return nextVoteMap[voteField] == prevVoteMap[voteField] + 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([voteField]);
    }
    
    function isVoteDecrement(voteType, voteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];

        return nextVoteMap[voteField] == prevVoteMap[voteField] - 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([voteField]);
    }

    function isChangingVote(voteType, oldVoteField, newVoteField) {
        let nextVoteMap = request.resource.data[voteType];
        let prevVoteMap = resource.data[voteType];

        return nextVoteMap[oldVoteField] == prevVoteMap[oldVoteField] - 1 &&
               nextVoteMap[newVoteField] == prevVoteMap[newVoteField] + 1 &&
               nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([oldVoteField, newVoteField]);
    }

    // ðŸ† NUEVA FUNCIÃ“N: Verifica la seguridad y atomicidad del cambio de calificaciÃ³n
    function isRatingChangeValid(count, ratingValue) {
        // 1. Verifica si ratingCount cambia correctamente (+1 o -1)
        let countCheck = isIncrement('ratingCount', count);
        
        // 2. Verifica si totalRating cambia por el valor de la calificaciÃ³n (+/- ratingValue)
        let totalRatingCheck = isIncrement('totalRating', count * ratingValue);

        // 3. Verifica que ratingsBreakdown solo se modifique en el Ã­ndice de la calificaciÃ³n
        let breakdownKeys = request.resource.data.ratingsBreakdown.diff(resource.data.ratingsBreakdown).affectedKeys();
        let breakdownCheck = breakdownKeys.hasOnly([string(ratingValue)]);

        // 4. Verifica si el bucket especÃ­fico de ratingsBreakdown cambia correctamente (+1 o -1)
        let nextBucketValue = request.resource.data.ratingsBreakdown[string(ratingValue)];
        let prevBucketValue = resource.data.ratingsBreakdown[string(ratingValue)];
        let bucketChangeCheck = nextBucketValue == prevBucketValue + count || (prevBucketValue == null && nextBucketValue == count);

        return countCheck && totalRatingCheck && breakdownCheck && bucketChangeCheck;
    }
    
    // --- User Data Collections ---

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();

      // Rules for user's private subcollections
      match /attitudeVotes/{figureId} {
        allow get, write: if isOwner(userId);
        allow list: if isOwner(userId);
      }
      match /emotionVotes/{figureId} {
        allow get, write: if isOwner(userId);
        allow list: if isOwner(userId);
      }
      match /streaks/{streakId} {
        allow get, list, write: if isOwner(userId);
      }
      match /user_achievements/{achievementId} {
        allow get, list, write: if isOwner(userId);
      }
      match /notifications/{notificationId} {
          allow read, update, delete: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isSignedIn();
      }
      match /referrals/{referredUserId} {
        allow read, write: if isOwner(userId);
      }
    }

    match /status/{userId} {
      allow read, write: if isOwner(userId);
      allow list: if false;
    }

    match /usernames/{username} {
      allow get: if true; 
      allow list: if false;
      allow create: if isSignedIn(); 
      allow delete: if get(/databases/$(database)/documents/usernames/$(username)).data.userId == request.auth.uid;
      allow update: if false;
    }

    // --- Figure Data Collections ---

    match /figures/{figureId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow delete: if isAdmin();
      
      allow update: if isAdmin() || (
        isSignedIn() && (
          // Permiso 1: EdiciÃ³n de campos Wiki
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'name', 'imageUrl', 'imageHint', 'nationality', 'tags', 'tagsLower', 'description', 
            'gender', 'birthDate', 'deathDate', 'occupation', 'maritalStatus', 'height', 'socialLinks', 'nameKeywords', 'updatedAt'
          ])) ||
          
          // Permiso 2: VotaciÃ³n de Actitud (Contrato estricto)
          (request.resource.data.__newVote != null && 
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attitude', 'updatedAt', '__oldVote', '__newVote']) &&
            (
              (request.resource.data.__oldVote == null && isVoteIncrement('attitude', request.resource.data.__newVote)) ||
              (request.resource.data.__oldVote == request.resource.data.__newVote && isVoteDecrement('attitude', request.resource.data.__oldVote)) ||
              (request.resource.data.__oldVote != request.resource.data.__newVote && isChangingVote('attitude', request.resource.data.__oldVote, request.resource.data.__newVote))
            )
          ) ||

          // Permiso 3: VotaciÃ³n de EmociÃ³n (Contrato estricto)
          (request.resource.data.__newVote != null &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['emotion', 'updatedAt', '__oldVote', '__newVote']) &&
            (
              (request.resource.data.__oldVote == null && isVoteIncrement('emotion', request.resource.data.__newVote)) ||
              (request.resource.data.__oldVote == request.resource.data.__newVote && isVoteDecrement('emotion', request.resource.data.__oldVote)) ||
              (request.resource.data.__oldVote != request.resource.data.__newVote && isChangingVote('emotion', request.resource.data.__oldVote, request.resource.data.__newVote))
            )
          ) ||
          
          // Permiso 4: ActualizaciÃ³n de CalificaciÃ³n (GOAT - Contrato estricto y Seguro)
          (request.resource.data.__ratingValue is number && request.resource.data.__ratingValue >= 0 && request.resource.data.__ratingValue <= 5 &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              'ratingCount', 'totalRating', 'ratingsBreakdown', 'updatedAt', '__ratingValue'
            ]) &&
            (
              // AÃ±adir una calificaciÃ³n (count = 1)
              isRatingChangeValid(1, request.resource.data.__ratingValue) ||
              // Remover una calificaciÃ³n (count = -1)
              isRatingChangeValid(-1, request.resource.data.__ratingValue)
            )
          )
        )
      );
      
      // Rules for public-facing subcollections within figures
      match /attitudeVotes/{userId} {
          allow get, write: if isOwner(userId);
      }
      match /emotionVotes/{userId} {
          allow get, write: if isOwner(userId);
      }
      
      match /comments/{commentId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        
        allow update: if isSignedIn() && (
            // Bloque 1: EdiciÃ³n de texto segura (dueÃ±o y solo texto/updatedAt)
            (resource.data.userId == request.auth.uid && 
              request.resource.data.text != resource.data.text &&
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'updatedAt'])) ||

            // Bloque 2: ActualizaciÃ³n atÃ³mica de 'likes' (+1 o -1)
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']) && 
              (isIncrement('likes', 1) || isIncrement('likes', -1))) ||

            // Bloque 3: ActualizaciÃ³n atÃ³mica de 'dislikes' (+1 o -1)
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dislikes']) && 
              (isIncrement('dislikes', 1) || isIncrement('dislikes', -1))) ||
                
            // Bloque 4: CAMBIO DE VOTO ATÃ“MICO LIKES/DISLIKES
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes']) &&
                (
                    // Like a Dislike (-1 like, +1 dislike)
                    (isIncrement('likes', -1) && isIncrement('dislikes', 1)) ||
                    // Dislike a Like (-1 dislike, +1 like)
                    (isIncrement('dislikes', -1) && isIncrement('likes', 1))
                )
            )
        );
        
        allow delete: if resource.data.userId == request.auth.uid || isAdmin();

        match /votes/{userId} {
          // ðŸ›‘ CORRECCIÃ“N: Soluciona el error de "Missing or insufficient permissions" en la lectura.
          allow get: if request.auth.uid == userId; 
          allow write: if isOwner(userId);
          allow list: if false;
        }

        match /replies/{replyId} {
          allow get, list: if true;
          allow create: if isSignedIn();
          
          allow update: if isSignedIn() && (
              // Bloque 1: EdiciÃ³n de texto segura (dueÃ±o y solo texto/updatedAt)
              (resource.data.userId == request.auth.uid && 
                request.resource.data.text != resource.data.text &&
                request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'updatedAt'])) ||

              // Bloque 2: ActualizaciÃ³n atÃ³mica de 'likes' (+1 o -1)
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']) && 
                (isIncrement('likes', 1) || isIncrement('likes', -1))) ||

              // Bloque 3: ActualizaciÃ³n atÃ³mica de 'dislikes' (+1 o -1)
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dislikes']) && 
                (isIncrement('dislikes', 1) || isIncrement('dislikes', -1))) ||
                  
              // Bloque 4: CAMBIO DE VOTO ATÃ“MICO LIKES/DISLIKES
              (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes']) &&
                  (
                      (isIncrement('likes', -1) && isIncrement('dislikes', 1)) ||
                      (isIncrement('dislikes', -1) && isIncrement('likes', 1))
                  )
              )
          );
          
          allow delete: if 
            resource.data.userId == request.auth.uid ||
            get(/databases/$(database)/documents/figures/$(figureId)/comments/$(commentId)).data.userId == request.auth.uid ||
            isAdmin();
            
          match /votes/{userId} {
            // ðŸ›‘ CORRECCIÃ“N: Soluciona el error de "Missing or insufficient permissions" en la lectura.
            allow get: if request.auth.uid == userId;
            allow write: if isOwner(userId);
            allow list: if false;
          }
        }
      }

      match /streaks/{userId} {
        allow read, list: if true; 
        allow write: if isOwner(userId);
      }

      match /achievements/{userAchievementId} {
          allow read, list: if true;
          allow create: if isSignedIn();
          allow delete, update: if false;
      }
    }
    
    // --- Other Root-Level Collections ---

    match /hashtags/{hashtagId} {
        allow get, list: if true;
        allow write: if isSignedIn();
    }
    
    match /achievements/{achievementId} {
        allow get, list: if true;
        allow write: if isAdmin();
    }


    match /related_figures/{relatedFigureId} {
      allow get, list: if true;
      allow create, delete: if isSignedIn();
      allow update: if false;
    }

    match /goat_battles/{battleId} {
        allow get, list: if true;
        allow create, delete: if isAdmin();

        allow update: if (
            isAdmin() || (
                isSignedIn() && (
                    // P1: Handle single vote/un-vote for Messi
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['messiVotes']) &&
                        (isIncrement('messiVotes', 1) || isIncrement('messiVotes', -1))) ||

                    // P2: Handle single vote/un-vote for Ronaldo
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ronaldoVotes']) &&
                        (isIncrement('ronaldoVotes', 1) || isIncrement('ronaldoVotes', -1))) ||
                        
                    // P3: Handle changing a vote (e.g., from Messi to Ronaldo)
                    (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['messiVotes', 'ronaldoVotes']) &&
                        (
                        (isIncrement('messiVotes', 1) && isIncrement('ronaldoVotes', -1)) ||
                        (isIncrement('messiVotes', -1) && isIncrement('ronaldoVotes', 1))
                        )
                    )
                )
            )
        );
        
        match /votes/{userId} {
            // ðŸ›‘ CORRECCIÃ“N: Soluciona el error de "Missing or insufficient permissions" en la lectura.
            allow get: if request.auth.uid == userId;
            allow write: if isOwner(userId);
            allow list: if false;
        }
    }
    
    match /roles_admin/{userId} {
      allow get: if isSignedIn();
      allow write: if isAdmin();
      allow list: if false;
    }
    
    match /settings/{settingId} {
      allow get: if true;
      allow write: if isAdmin();
    }
  }
}
