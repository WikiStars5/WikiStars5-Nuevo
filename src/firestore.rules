
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Global Helper Functions ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    function isIncrement(field, count) {
      let nextValue = request.resource.data[field];
      let prevValue = resource.data[field];
      return nextValue == prevValue + count || (prevValue == null && nextValue == count); 
    }
    
    function getGlobalSettings() {
      return get(/databases/$(database)/documents/settings/global).data;
    }

    function areCommentsEnabled() {
      return getGlobalSettings().isCommentingEnabled == true;
    }

    function areRepliesEnabled() {
      return getGlobalSettings().isReplyEnabled == true;
    }

    function areRatingsEnabled() {
      return getGlobalSettings().isRatingEnabled == true;
    }

    
    // --- User Data Collections ---

    match /users/{userId} {
      allow get: if (isSignedIn() && isOwner(userId)) || isAdmin();
      allow list: if isAdmin();
      // Allow creation for any signed-in user, including anonymous, for their own profile
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();

      // Users can manage their own private data
      match /attitudeVotes/{figureId} { allow get, write: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); }
      match /emotionVotes/{figureId} { allow get, write: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); }
      match /streaks/{streakId} { allow get, write: if isOwner(userId) || isAdmin(); allow list: if isOwner(userId) || isAdmin(); }
      match /user_achievements/{achievementId} { allow get, write: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); }
      match /notifications/{notificationId} { allow read, update, delete: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); allow create: if isSignedIn(); }
      match /referrals/{referredUserId} { allow read, write: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); }
      match /adCampaigns/{campaignId} { allow read, write: if isOwner(userId) || isAdmin(); }
    }

    
    match /usernames/{username} {
      allow get: if true; 
      allow list: if false;
      // Allow any signed-in user (including anonymous) to create a username document
      allow create: if isSignedIn(); 
      allow delete: if get(/databases/$(database)/documents/usernames/$(username)).data.userId == request.auth.uid;
      allow update: if false;
    }

    // --- Figure Data Collections ---

    match /figures/{figureId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow delete: if isAdmin();
      
      allow update: if isAdmin() || (isSignedIn() && (
        // Allow general wiki-style edits
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'imageUrl', 'imageHint', 'nationality', 'description', 'gender', 'birthDate', 'deathDate', 'occupation', 'maritalStatus', 'height', 'socialLinks', 'nameKeywords', 'updatedAt']) ||
        // Allow simple counter updates for votes
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attitude']) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['emotion']) ||
        // Allow simple counter updates for ratings
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ratingCount', 'totalRating']) ||
        request.resource.data.diff(resource.data).hasAny(['ratingsBreakdown.0', 'ratingsBreakdown.1', 'ratingsBreakdown.2', 'ratingsBreakdown.3', 'ratingsBreakdown.4', 'ratingsBreakdown.5'])
      ));
      
      // Allow any signed-in user to cast their vote
      match /attitudeVotes/{userId} { allow get, write: if isOwner(userId); }
      match /emotionVotes/{userId} { allow get, write: if isOwner(userId); }

      // Allow write access to aggregation subcollections for any signed-in user
      match /attitudeStats/{statId} { allow read, list, write: if isSignedIn(); }
      match /emotionStats/{statId} { allow read, list, write: if isSignedIn(); }
      match /ratingStats/{rating} { allow read, list, write: if isSignedIn(); }
      
      match /comments/{commentId} {
        allow get, list: if true;
        
        allow create: if (isAdmin()) || (isSignedIn() && request.resource.data.userId == request.auth.uid && (
            (areCommentsEnabled() && request.resource.data.text is string && request.resource.data.text.size() > 0) ||
            (!areCommentsEnabled() && areRatingsEnabled() && request.resource.data.rating >= 0 && request.resource.data.rating <= 5)
        ));
        
        allow update: if isSignedIn() && (
            (resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'updatedAt'])) || 
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes'])) ||
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])) ||
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dislikes'])) ||
            (isIncrement('replyCount', 1) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount']))
        );
        
        allow delete: if resource.data.userId == request.auth.uid || isAdmin();

        match /votes/{userId} { allow get, write: if isOwner(userId); allow list: if false; }

        match /replies/{replyId} {
          allow get, list: if true;
          allow create: if (isAdmin()) || (isSignedIn() && areRepliesEnabled() && request.resource.data.userId == request.auth.uid && request.resource.data.text is string && request.resource.data.text.size() > 0);
          allow update: if isSignedIn() && (
            (resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'updatedAt'])) ||
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes'])) ||
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])) ||
            (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dislikes']))
          );
          allow delete: if resource.data.userId == request.auth.uid || get(/databases/$(database)/documents/figures/$(figureId)/comments/$(commentId)).data.userId == request.auth.uid || isAdmin();
          match /votes/{userId} { allow get, write: if isOwner(userId); allow list: if false; }
        }
      }

      match /streaks/{userId} { allow read, list: if true; allow write: if isOwner(userId) || isAdmin(); }
    }
    
    // --- Collection Group Rules ---
    match /{path=**}/comments/{commentId} {
      allow get: if isAdmin();
      allow list: if isAdmin();
    }
    
    // --- Other Root-Level Collections ---

    match /achievements/{achievementId} { allow get, list: if true; allow write: if isAdmin(); }
    
    match /related_figures/{relatedFigureId} { 
      allow get, list: if true; 
      allow create, delete: if isSignedIn() && request.auth.token.firebase.sign_in_provider != 'anonymous';
      allow update: if false; 
    }

    match /goat_battles/{battleId} {
        allow get, list: if true;
        allow create, delete: if isAdmin();
        allow update: if isSignedIn();
        match /votes/{userId} { 
          allow get: if isOwner(userId) || isAdmin(); 
          allow write: if isOwner(userId); 
          allow list: if isAdmin(); 
        }
    }
    
    match /roles_admin/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow write: if isAdmin();
      allow list: if false;
    }
    match /settings/{settingId} { allow get: if true; allow write: if isAdmin(); }
  }
}
