
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Utilidad Reutilizables ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isIncrement(field, count) {
      return (resource.data[field] == null && request.resource.data[field] == count) || 
             (request.resource.data[field] == resource.data[field] + count);
    }
    
    function getGlobalSettings() {
      return get(/databases/$(database)/documents/settings/global).data;
    }

    function areCommentsEnabled() {
      return getGlobalSettings().isCommentingEnabled == true;
    }
    
    function areRepliesEnabled() {
      return getGlobalSettings().isReplyEnabled == true;
    }
    
    function areRatingsEnabled() {
      return getGlobalSettings().isRatingEnabled == true;
    }
    
    // --- Funciones de Validación de Votos ---
    
    function isVoteIncrement(voteType, voteField) {
      let prevVoteMap = resource.data[voteType] != null ? resource.data[voteType] : {};
      let nextVoteMap = request.resource.data[voteType];
      let prevCount = prevVoteMap[voteField] != null ? prevVoteMap[voteField] : 0;
      return nextVoteMap[voteField] == prevCount + 1 && nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([voteField]);
    }

    function isVoteDecrement(voteType, voteField) {
      let prevVoteMap = resource.data[voteType] != null ? resource.data[voteType] : {};
      let nextVoteMap = request.resource.data[voteType];
      let prevCount = prevVoteMap[voteField];
      return prevCount != null && nextVoteMap[voteField] == prevCount - 1 && nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([voteField]);
    }

    function isChangingVote(voteType, oldVoteField, newVoteField) {
      let prevVoteMap = resource.data[voteType] != null ? resource.data[voteType] : {};
      let nextVoteMap = request.resource.data[voteType];
      let prevOldCount = prevVoteMap[oldVoteField];
      let prevNewCount = prevVoteMap[newVoteField] != null ? prevVoteMap[newVoteField] : 0;
      return prevOldCount != null && nextVoteMap[oldVoteField] == prevOldCount - 1 && nextVoteMap[newVoteField] == prevNewCount + 1 && nextVoteMap.diff(prevVoteMap).affectedKeys().hasOnly([oldVoteField, newVoteField]);
    }
    
    // --- Reglas de Colecciones ---

    match /users/{userId} {
      allow get: if (isSignedIn() && isOwner(userId)) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();

      match /attitudeVotes/{figureId} { allow get, write: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); }
      match /emotionVotes/{figureId} { allow get, write: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); }
      match /streaks/{streakId} { allow get, write: if isOwner(userId) || isAdmin(); allow list: if isOwner(userId) || isAdmin(); }
      match /notifications/{notificationId} { allow read, update, delete: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); allow create: if isSignedIn(); }
      match /referrals/{referredUserId} { allow read, write: if isOwner(userId); allow list: if isOwner(userId) || isAdmin(); }
      match /adCampaigns/{campaignId} { allow read, write: if isOwner(userId) || isAdmin(); }
    }

    match /usernames/{username} {
      allow get: if true; 
      allow list: if false;
      allow create: if isSignedIn(); 
      allow delete: if get(/databases/$(database)/documents/usernames/$(username)).data.userId == request.auth.uid;
      allow update: if false;
    }

    match /figures/{figureId} {
      allow get, list: if true;
      allow create: if isSignedIn() && isAdmin();
      allow delete: if isAdmin();
      
      allow update: if isAdmin() || (
        isSignedIn() && (
          // Regla 1: Permite a los usuarios editar campos de información básica.
          (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'imageUrl', 'imageHint', 'coverPhotoUrl', 'nationality', 'description', 'gender', 'birthDate', 'deathDate', 'occupation', 'maritalStatus', 'height', 'socialLinks', 'nameKeywords', 'updatedAt'])) ||
          
          // Regla 2: Valida los cambios en los votos de actitud.
          (request.resource.data.__newVote != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attitude', 'updatedAt', '__oldVote', '__newVote']) && (
            (request.resource.data.__oldVote == null && isVoteIncrement('attitude', request.resource.data.__newVote)) ||
            (request.resource.data.__oldVote == request.resource.data.__newVote && isVoteDecrement('attitude', request.resource.data.__oldVote)) ||
            (request.resource.data.__oldVote != request.resource.data.__newVote && isChangingVote('attitude', request.resource.data.__oldVote, request.resource.data.__newVote))
          )) ||

          // Regla 3: Valida los cambios en los votos de emoción.
          (request.resource.data.__newVote != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['emotion', 'updatedAt', '__oldVote', '__newVote']) && (
            (request.resource.data.__oldVote == null && isVoteIncrement('emotion', request.resource.data.__newVote)) ||
            (request.resource.data.__oldVote == request.resource.data.__newVote && isVoteDecrement('emotion', request.resource.data.__oldVote)) ||
            (request.resource.data.__oldVote != request.resource.data.__newVote && isChangingVote('emotion', request.resource.data.__oldVote, request.resource.data.__newVote))
          )) ||

          // Regla 4: Valida los cambios en las calificaciones de estrellas al crear un comentario.
          (
            request.resource.data.diff(resource.data).affectedKeys().hasAny(['ratingCount', 'totalRating', 'ratingsBreakdown']) &&
            request.resource.data.ratingCount == resource.data.ratingCount + 1
          )
        )
      );
      
      match /attitudeStats/{statId} { allow read, list: if true; allow write: if isSignedIn() || isAdmin(); }
      match /emotionStats/{statId} { allow read, list: if true; allow write: if isSignedIn() || isAdmin(); }
      match /ratingStats/{rating} { allow read, list: if true; allow write: if isSignedIn() || isAdmin(); }
      match /streakStats/{day} { allow read, list: if true; allow write: if isSignedIn() || isAdmin(); }
      
      match /comments/{commentId} {
        allow get, list: if true;
        
        // PERMITE CREAR un comentario si el usuario es el dueño Y (los comentarios de texto están habilitados O las calificaciones están habilitadas y se proporciona una).
        allow create: if (isAdmin()) || (request.resource.data.userId == request.auth.uid && (
            (areCommentsEnabled() && request.resource.data.text is string) ||
            (areRatingsEnabled() && request.resource.data.rating >= 0 && request.resource.data.rating <= 5)
          )
        );
        
        // PERMITE ACTUALIZAR si el usuario es el dueño (para editar texto) O CUALQUIER usuario autenticado puede actualizar likes/dislikes (SIMPLE).
        allow update: if isSignedIn() && (
            (resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'updatedAt', 'title', 'tag'])) || 
            (isIncrement('likes', 1) || isIncrement('likes', -1) || isIncrement('dislikes', 1) || isIncrement('dislikes', -1)) ||
            (isIncrement('replyCount', 1))
        );
        
        allow delete: if resource.data.userId == request.auth.uid || isAdmin();

        match /votes/{userId} { allow get, write: if isOwner(userId); allow list: if false; }

        match /replies/{replyId} {
          allow get, list: if true;
          
          allow create: if (isAdmin()) || (
            isSignedIn() && 
            areRepliesEnabled() && 
            request.resource.data.userId == request.auth.uid && 
            request.resource.data.text is string && 
            request.resource.data.text.size() > 0
          );
          
          // PERMITE ACTUALIZAR si el usuario es el dueño (para editar texto) O CUALQUIER usuario autenticado puede actualizar likes/dislikes (SIMPLE).
          allow update: if isSignedIn() && (
            (resource.data.userId == request.auth.uid && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['text', 'updatedAt'])) ||
            (isIncrement('likes', 1) || isIncrement('likes', -1) || isIncrement('dislikes', 1) || isIncrement('dislikes', -1))
          );
          
          allow delete: if resource.data.userId == request.auth.uid || get(/databases/$(database)/documents/figures/$(figureId)/comments/$(commentId)).data.userId == request.auth.uid || isAdmin();
          
          match /votes/{userId} { allow get, write: if isOwner(userId); allow list: if false; }
        }
      }

      match /streaks/{userId} { allow read, list: if true; allow write: if isOwner(userId) || isAdmin(); }
    }
    
    // REGLA CLAVE FALTANTE: Permite la creación de starposts
    match /starposts/{commentId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid; // Solo el dueño puede crear su propio starpost
      allow update, delete: if isAdmin();
    }
    
    match /{path=**}/comments/{commentId} {
      allow read;
      allow write: if false;
    }
    
    match /achievements/{achievementId} { allow get, list: if true; allow write: if isAdmin(); }
    
    match /related_figures/{relatedFigureId} { 
      allow get, list: if true; 
      allow create, delete: if isSignedIn() && request.auth.token.firebase.sign_in_provider != 'anonymous';
      allow update: if false; 
    }

    match /goat_battles/{battleId} {
        allow get, list: if true;
        allow create, delete, update: if isAdmin(); // Simplificado: solo el admin gestiona la batalla
        
        match /votes/{userId} { 
          allow get: if isOwner(userId) || isAdmin(); 
          allow write: if isOwner(userId); 
          allow list: if isAdmin(); 
        }
    }
    
    match /roles_admin/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow write: if isAdmin();
      allow list: if isAdmin();
    }
    
    match /settings/{settingId} { 
      allow read: if true; 
      allow write: if isAdmin(); 
    }
    
    match /featured_figures/{figureId} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }
  }
}
